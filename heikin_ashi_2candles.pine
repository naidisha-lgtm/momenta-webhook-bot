//@version=6
indicator("2 Same Color Heikin Ashi (No Repaint)", overlay=true)

// ====================================
// DESCRIPTION
// ====================================
// This indicator detects 2 consecutive same-color Heikin Ashi candles
// and generates trading signals on regular candles.
//
// KEY FEATURES:
// - NO REPAINTING: Signals fire only on bar close (barstate.isconfirmed)
// - Regular candles displayed on chart (not HA candles)
// - HA logic calculated in background for signal generation
// - LONG: 2 consecutive green (bullish) HA candles
// - SHORT: 2 consecutive red (bearish) HA candles
// - Webhook-ready alert messages for automated trading
//
// USAGE:
// 1. Add indicator to chart (regular candles, any timeframe)
// 2. Set up alerts with webhook URL
// 3. Signals appear ONLY after candle closes (no repaint)
//
// IMPORTANT:
// - Set alert frequency to "Once Per Bar Close" for best results
// - Signals will not change after they appear (confirmed)
// - Optional: Enable "Show Heikin Ashi Candles" to see HA overlay

// ====================================
// SETTINGS
// ====================================

show_ha_candles = input.bool(false, "Show Heikin Ashi Candles",
                             tooltip="Enable to overlay HA candles on chart. Disable to show only regular candles with signals.")

// ====================================
// HEIKIN ASHI CALCULATION (NO REPAINT)
// ====================================

// Calculate HA values using confirmed/closed bars only
// This ensures signals don't repaint

// Heikin Ashi Close (uses OHLC of current bar)
ha_close = (open + high + low + close) / 4

// Heikin Ashi Open (uses previous HA values)
var float ha_open = na
ha_open := na(ha_open[1]) ? (open + close) / 2 : (ha_open[1] + ha_close[1]) / 2

// Heikin Ashi High
ha_high = math.max(high, math.max(ha_open, ha_close))

// Heikin Ashi Low
ha_low = math.min(low, math.min(ha_open, ha_close))

// ====================================
// CANDLE COLOR DETECTION (CONFIRMED BARS)
// ====================================

// Use CONFIRMED data from previous bars to avoid repainting
// Current bar HA values (will be confirmed when bar closes)
current_bullish = ha_close > ha_open
current_bearish = ha_close < ha_open

// Previous confirmed bar HA values
prev_bullish = ha_close[1] > ha_open[1]
prev_bearish = ha_close[1] < ha_open[1]

// ====================================
// SIGNAL LOGIC (BAR CLOSE ONLY)
// ====================================

// 2 consecutive bullish (green) candles - CONFIRMED
// Check that current bar is bullish AND previous bar was bullish
two_green_confirmed = current_bullish and prev_bullish

// 2 consecutive bearish (red) candles - CONFIRMED
two_red_confirmed = current_bearish and prev_bearish

// Generate signals ONLY on bar close (no repainting)
// Signal fires when pattern first appears (not on every bar with pattern)
long_signal = barstate.isconfirmed and two_green_confirmed and not two_green_confirmed[1]
short_signal = barstate.isconfirmed and two_red_confirmed and not two_red_confirmed[1]

// ====================================
// VISUAL INDICATORS
// ====================================

// Optional: Plot Heikin Ashi candles as overlay (disabled by default)
plotcandle(show_ha_candles ? ha_open : na,
           show_ha_candles ? ha_high : na,
           show_ha_candles ? ha_low : na,
           show_ha_candles ? ha_close : na,
           title="Heikin Ashi Overlay",
           color=ha_close >= ha_open ? color.new(color.green, 70) : color.new(color.red, 70),
           wickcolor=ha_close >= ha_open ? color.new(color.green, 70) : color.new(color.red, 70),
           bordercolor=ha_close >= ha_open ? color.new(color.green, 70) : color.new(color.red, 70))

// Plot signal markers on REGULAR candles (not HA)
plotshape(long_signal,
          title="LONG Signal",
          location=location.belowbar,
          color=color.green,
          style=shape.triangleup,
          size=size.small,
          text="LONG")

plotshape(short_signal,
          title="SHORT Signal",
          location=location.abovebar,
          color=color.red,
          style=shape.triangledown,
          size=size.small,
          text="SHORT")

// Background highlight for signal bars
bgcolor(long_signal ? color.new(color.green, 90) : na, title="LONG Background")
bgcolor(short_signal ? color.new(color.red, 90) : na, title="SHORT Background")

// Visual indicator of HA trend on regular candles
barcolor(show_ha_candles ? na :
         two_green_confirmed ? color.new(color.green, 70) :
         two_red_confirmed ? color.new(color.red, 70) : na,
         title="HA Pattern Bar Color")

// ====================================
// ALERTS (NO REPAINT)
// ====================================

// Alert conditions - these fire ONLY on bar close
// Webhook receives these messages
alertcondition(long_signal,
               title="LONG Signal Alert",
               message='{"signal":"LONG"}')

alertcondition(short_signal,
               title="SHORT Signal Alert",
               message='{"signal":"SHORT"}')

// Combined alert - fires for either signal
alertcondition(long_signal or short_signal,
               title="Any Signal Alert",
               message='{"signal":"{{plot_0}}"}')

// ====================================
// DASHBOARD (Optional)
// ====================================

// Create a simple info table
var table info_table = table.new(position.top_right, 2, 5,
                                  bgcolor=color.new(color.black, 80),
                                  border_width=1,
                                  border_color=color.gray)

if barstate.islast
    table.cell(info_table, 0, 0, "Indicator", text_color=color.white, bgcolor=color.new(color.blue, 70))
    table.cell(info_table, 1, 0, "2 Same HA (No Repaint)", text_color=color.white)

    table.cell(info_table, 0, 1, "HA Trend", text_color=color.white, bgcolor=color.new(color.blue, 70))
    current_state = current_bullish ? "Bullish" : current_bearish ? "Bearish" : "Neutral"
    state_color = current_bullish ? color.green : current_bearish ? color.red : color.gray
    table.cell(info_table, 1, 1, current_state, text_color=state_color)

    table.cell(info_table, 0, 2, "Pattern", text_color=color.white, bgcolor=color.new(color.blue, 70))
    consecutive_text = two_green_confirmed ? "2 Green ✓" : two_red_confirmed ? "2 Red ✓" : "No Pattern"
    table.cell(info_table, 1, 2, consecutive_text, text_color=color.white)

    table.cell(info_table, 0, 3, "Last Signal", text_color=color.white, bgcolor=color.new(color.blue, 70))
    signal_text = long_signal ? "LONG" : short_signal ? "SHORT" : "-"
    signal_color = long_signal ? color.green : short_signal ? color.red : color.gray
    table.cell(info_table, 1, 3, signal_text, text_color=signal_color)

    table.cell(info_table, 0, 4, "Bar Status", text_color=color.white, bgcolor=color.new(color.blue, 70))
    bar_status = barstate.isconfirmed ? "Closed ✓" : "In Progress..."
    bar_status_color = barstate.isconfirmed ? color.green : color.orange
    table.cell(info_table, 1, 4, bar_status, text_color=bar_status_color)
